#include <iostream>
#include <windows.h>
#include <stdlib.h>
#include <stdio.h>

#define ARRIBA    72
#define IZQUIERDA 75
#define DERECHA   77
#define ABAJO     80
#define ESC       27

int cuerpo[200][2];
int n = 1;
int tam = 5;
int x = 10, y = 12;
int dir = 3;
int xc = 30, yc = 15;
int velocidad = 150, h = 1;
int score = 0;
int w = 100;

char tecla;

void gotoxy(int x, int y) {
    HANDLE hCon;
    COORD dwPos;
    dwPos.X = x;
    dwPos.Y = y;
    hCon = GetStdHandle(STD_OUTPUT_HANDLE);
    SetConsoleCursorPosition(hCon, dwPos);
}

void pintar() {
    for (int i = 2; i < 78; i++) {
        gotoxy(i, 3); printf("%c", 205);
        gotoxy(i, 23); printf("%c", 205);
    }
    for (int v = 4; v < 23; v++) {
        gotoxy(2, v); printf("%c", 186);
        gotoxy(77, v); printf("%c", 186);
    }
    gotoxy(2, 3); printf("%c", 201);
    gotoxy(2, 23); printf("%c", 200);
    gotoxy(77, 3); printf("%c", 187);
    gotoxy(77, 23); printf("%c", 188);
}

void guardar_posicion() {
    cuerpo[n][0] = x;
    cuerpo[n][1] = y;
    n++;
    if (n == tam) n = 1;
}

void dibujar_cuerpo() {
    for (int i = 1; i < tam; i++) {
        gotoxy(cuerpo[i][0], cuerpo[i][1]); printf("%c", 2);
    }
}

void borrar_cuerpo() {
    gotoxy(cuerpo[n][0], cuerpo[n][1]); printf(" ");
}

bool tecla_presionada() {
    return GetAsyncKeyState(VK_UP) || GetAsyncKeyState(VK_DOWN) ||
           GetAsyncKeyState(VK_LEFT) || GetAsyncKeyState(VK_RIGHT) || 
           GetAsyncKeyState(VK_ESCAPE);
}

char obtener_tecla() {
    if (GetAsyncKeyState(VK_UP)) return ARRIBA;
    if (GetAsyncKeyState(VK_DOWN)) return ABAJO;
    if (GetAsyncKeyState(VK_LEFT)) return IZQUIERDA;
    if (GetAsyncKeyState(VK_RIGHT)) return DERECHA;
    if (GetAsyncKeyState(VK_ESCAPE)) return ESC;
    return '\0';
}

void teclear() {
    if (tecla_presionada()) {
        tecla = obtener_tecla();
        switch (tecla) {
            case ARRIBA:
                if (dir != 2) dir = 1;
                break;
            case ABAJO:
                if (dir != 1) dir = 2;
                break;
            case DERECHA:
                if (dir != 4) dir = 3;
                break;
            case IZQUIERDA:
                if (dir != 3) dir = 4;
                break;
        }
    }
}

void comida() {
    if (x == xc && y == yc) {
        xc = (rand() % 73) + 4;
        yc = (rand() % 19) + 4;
        tam++;
        score += 10;
        gotoxy(xc, yc); printf("%c", 4);
    }
}

bool game_over() {
    if (y == 3 || y == 23 || x == 2 || x == 77) return false;
    for (int j = tam - 1; j > 0; j--) {
        if (cuerpo[j][0] == x && cuerpo[j][1] == y) return false;
    }
    return true;
}

void puntos() {
    gotoxy(3, 1); printf("Score: %d", score);
}

bool win() {
    return !(score >= w);
}

void titulo() {
    printf("\n\n");
    printf("\t\t\t%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c\n", 201,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,187);
    printf("\t\t\t%c  || S.N.A.K.E ||  %c\n", 186, 186);
    printf("\t\t\t%c   \\===========/   %c\n", 186, 186);
    printf("\t\t\t%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c\n", 200,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,205,188);
    printf("\n\t\tInstrucciones: \n");
    printf("\t- Gana al alcanzar %d puntos.\n", w);
    printf("\t- Pierdes al chocar con el marco o contigo mismo.\n");
    printf("\t- Usa las flechas del teclado para moverte.\n");
    printf("\tPresiona Enter para comenzar...\n");
    system("pause>NULL");
    system("cls");
}

void game() {
    while (game_over() && win()) {
        puntos();
        borrar_cuerpo();
        guardar_posicion();
        dibujar_cuerpo();
        comida();
        teclear();

        if (dir == 1) y--;
        if (dir == 2) y++;
        if (dir == 3) x++;
        if (dir == 4) x--;

        Sleep(velocidad);
    }

    if (!game_over()) {
        MessageBox(NULL, "HAS PERDIDO", "GAME OVER", MB_OK);
    } else if (!win()) {
        MessageBox(NULL, "HAS GANADO", "FELICIDADES", MB_OK);
    }
    system("cls");
}

int main() {
    titulo();
    pintar();
    gotoxy(xc, yc); printf("%c", 4);
    game();
    system("pause>NULL");
    return 0;
}
